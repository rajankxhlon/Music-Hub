<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Hub - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- Root Variables (Matching Profile.html) --- */
        :root {
            --primary-color: #6a0dad; /* Deep Purple */
            --secondary-color: #ff69b4; /* Hot Pink */
            --accent-color: #8a2be2; /* Blue Violet */
            --text-color: #ffffff;
            --header-bg: rgba(0, 0, 0, 0.3); /* Slightly transparent dark for header */
            --main-bg-card: rgba(255, 255, 255, 0.1); /* Frosted glass effect for main cards */
            --button-bg: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            --button-hover-bg: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        }

        /* --- Global Styles (Matching Profile.html) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(135deg, #1e003a, #5b0060, #9f00a5); /* Same vibrant background */
            color: var(--text-color);
            box-sizing: border-box;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg width="100%" height="100%" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><filter id="f1" x="0" y="0"><feTurbulence type="fractalNoise" baseFrequency="0.005 0.005" numOctaves="2" seed="0" result="turb"/><feDiffuseLighting in="turb" lightingColor="white" surfaceScale="10" result="light"><feDistantLight azimuth="235" elevation="60"/></feDiffuseLighting><feComposite in="SourceGraphic" in2="light" operator="arithmetic" k1="1" k2="0" k3="0" k4="0"/></filter></defs><rect width="100%" height="100%" fill="none" filter="url(%23f1)"/></svg>') no-repeat center center/cover;
            opacity: 0.1;
            animation: backgroundPan 30s linear infinite alternate;
            z-index: -1;
        }

        @keyframes backgroundPan {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        .container {
            width: 100%;
            max-width: 1000px;
            margin: 20px auto; /* Centered with top/bottom margin */
            background-color: var(--main-bg-card);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 30px;
            box-sizing: border-box;
            flex-grow: 1; /* Allow container to grow and push footer down */
        }

        header {
            background-color: transparent; /* Background applied to container */
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-controls h1 {
            color: var(--secondary-color); /* Hot Pink */
            font-size: 2.2em; /* Slightly smaller for admin header */
            font-weight: 700;
            text-align: center;
            flex-grow: 1;
            margin: 0;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
        }

        .header-controls .logout-btn {
            background: linear-gradient(to right, #ff4d4d, #b30000); /* Red gradient for logout */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .header-controls .logout-btn:hover {
            background: linear-gradient(to right, #b30000, #ff4d4d);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        /* --- Section Styling (Auth and Song Forms/Lists) --- */
        .admin-form-section,
        .song-list-section {
            background-color: rgba(255, 255, 255, 0.08); /* Lighter frosted glass */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-form-section h2,
        .song-list-section h2,
        .auth-form h3 {
            color: var(--accent-color); /* Blue Violet */
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.05);
        }

        /* --- Form Elements --- */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.05em;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="file"],
        .form-group input[type="email"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.3); /* Darker transparent */
            color: var(--text-color);
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus,
        .form-group select:focus,
        .form-group input[type="file"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="password"]:focus {
            border-color: var(--secondary-color); /* Hot Pink focus */
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.3); /* Pink glow */
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2); /* Make checkbox slightly larger */
            accent-color: var(--primary-color); /* Deep Purple checkbox */
        }

        .form-group small {
            color: rgba(255, 255, 255, 0.6);
            display: block; /* Ensure small text is on its own line */
            margin-top: 5px;
        }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .form-actions button {
            background: var(--button-bg);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .form-actions button:hover {
            background: var(--button-hover-bg);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .form-actions button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        .form-actions .cancel-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b); /* Red gradient */
        }

        .form-actions .cancel-btn:hover {
            background: linear-gradient(to right, #c0392b, #e74c3c);
        }

        /* --- Auth Section Specific Styles --- */
        .auth-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 150px); /* Adjust to consider header/footer if they were fixed */
            padding: 0 20px;
            flex-grow: 1; /* Allow auth section to take available space */
        }

        .auth-form {
            background-color: var(--main-bg-card); /* Frosted glass */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            max-width: 450px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .auth-form h3 {
            color: var(--secondary-color); /* Hot Pink */
            margin-bottom: 30px;
            font-size: 2em;
        }

        .auth-message {
            text-align: center;
            margin-top: 25px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
            border: 1px solid transparent;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .auth-message.success {
            background-color: rgba(29, 185, 84, 0.2); /* Spotify Green with transparency */
            color: #1DB954;
            border-color: #1DB95450;
        }

        .auth-message.error {
            background-color: rgba(231, 76, 60, 0.2); /* Red with transparency */
            color: #e74c3c;
            border-color: #e74c3c50;
        }

        .auth-toggle-link {
            text-align: center;
            margin-top: 25px;
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.8);
        }

        .auth-toggle-link a {
            color: var(--accent-color); /* Blue Violet for links */
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease, text-decoration 0.2s ease;
        }

        .auth-toggle-link a:hover {
            color: var(--secondary-color); /* Hot Pink on hover */
            text-decoration: underline;
        }

        /* --- Song List Table Styling --- */
        .song-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }

        .song-table th, .song-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08); /* Softer border */
            color: var(--text-color);
        }

        .song-table th {
            background-color: rgba(255, 255, 255, 0.15); /* Slightly darker frosted glass */
            color: var(--accent-color); /* Blue Violet for headers */
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.05em;
        }

        .song-table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05); /* Very subtle hover effect */
        }

        .song-table td {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
        }

        .song-table .song-poster {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            vertical-align: middle;
            margin-right: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .song-table .actions button {
            background: var(--button-bg);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .song-table .actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: var(--button-hover-bg);
        }

        .song-table .actions .edit-btn {
            background: linear-gradient(to right, #007bff, #0056b3); /* Blue gradient */
        }
        .song-table .actions .edit-btn:hover {
            background: linear-gradient(to right, #0056b3, #007bff);
        }

        .song-table .actions .delete-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b); /* Red gradient */
        }
        .song-table .actions .delete-btn:hover {
            background: linear-gradient(to right, #c0392b, #e74c3c);
        }

        .song-table .actions .toggle-publish-btn {
            background: linear-gradient(to right, #f39c12, #e67e22); /* Orange gradient */
        }
        .song-table .actions .toggle-publish-btn:hover {
            background: linear-gradient(to right, #e67e22, #f39c12);
        }

        .song-table .status-published {
            color: var(--secondary-color); /* Hot Pink for published */
            font-weight: 700;
        }

        .song-table .status-unpublished {
            color: #e74c3c; /* Red for unpublished */
            font-weight: 700;
        }

        .hidden {
            display: none !important;
        }

        .publisher-info {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.5); /* Lighter grey */
            display: block; /* Ensure it's on its own line */
            margin-top: 5px;
        }

        .upload-status {
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--secondary-color); /* Hot Pink for success */
            text-align: center;
            font-weight: 600;
            border: 1px solid rgba(255, 105, 180, 0.3);
            background-color: rgba(255, 105, 180, 0.1);
            padding: 8px;
            border-radius: 5px;
        }
        .upload-status.error {
            color: #e74c3c;
            border-color: rgba(231, 76, 60, 0.3);
            background-color: rgba(231, 76, 60, 0.1);
        }

        #posterPreview {
            margin-top: 15px;
            text-align: center;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
        }
        #posterPreview img {
            max-width: 180px;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        #posterPreview p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85em;
        }

        /* --- Loading Screen Styles --- */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e003a, #5b0060, #9f00a5); /* Match body background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Ensure it's on top */
            color: var(--text-color);
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }

        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none; /* Make it unclickable when hidden */
        }

        #loadingOverlay img {
            max-width: 200px; /* Adjust size as needed */
            height: auto;
            animation: pulse 2s infinite ease-in-out;
            margin-bottom: 20px;
        }

        #loadingOverlay h2 {
            font-size: 2em;
            font-weight: 700;
            color: var(--secondary-color); /* Hot Pink */
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            animation: fadeIn 2s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.05); }
            100% { transform: scale(0.95); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive Table */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 15px auto;
            }

            .header-controls {
                flex-direction: column;
                align-items: center;
            }
            .header-controls h1 {
                margin-bottom: 15px;
                font-size: 1.8em;
            }
            .header-controls .logout-btn {
                padding: 8px 18px;
                font-size: 0.85em;
            }

            .admin-form-section h2, .song-list-section h2, .auth-form h3 {
                font-size: 1.6em;
                margin-bottom: 20px;
            }

            .admin-form-section, .song-list-section, .auth-form {
                padding: 20px;
                border-radius: 10px;
            }

            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            .form-actions button {
                width: 100%;
                padding: 10px 20px;
                font-size: 1em;
            }

            /* Responsive table behavior */
            .song-table, .song-table thead, .song-table tbody, .song-table th, .song-table td, .song-table tr {
                display: block;
            }

            .song-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .song-table tr {
                border: 1px solid rgba(255, 255, 255, 0.1);
                margin-bottom: 15px;
                border-radius: 10px;
                overflow: hidden;
                background-color: rgba(255, 255, 255, 0.05);
            }

            .song-table td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: right;
                font-size: 0.85em;
            }

            .song-table td:before {
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 700;
                color: var(--accent-color);
            }

            .song-table td:nth-of-type(1):before { content: "Poster"; }
            .song-table td:nth-of-type(2):before { content: "Title"; }
            .song-table td:nth-of-type(3):before { content: "Artist"; }
            .song-table td:nth-of-type(4):before { content: "Language"; }
            .song-table td:nth-of-type(5):before { content: "Plays"; }
            .song-table td:nth-of-type(6):before { content: "Published"; }
            .song-table td:nth-of-type(7):before { content: "Publisher"; }
            .song-table td:nth-of-type(8):before { content: "Actions"; } /* For All Songs */
            /* Adjusted for My Songs which has one less column (no publisher) */
            .song-table.my-songs-table td:nth-of-type(7):before { content: "Actions"; }


            .song-table .actions {
                text-align: right;
                display: flex;
                flex-wrap: wrap;
                justify-content: flex-end;
                gap: 5px;
                padding-top: 10px;
                border-top: 1px dashed rgba(255, 255, 255, 0.1);
                margin-top: 10px;
            }
            .song-table .actions button {
                padding: 6px 12px;
                font-size: 0.75em;
                margin-right: 0;
            }
        }

        @media (max-width: 480px) {
            .container {
                border-radius: 0;
                padding: 10px;
            }
            .auth-form {
                padding: 25px;
                border-radius: 10px;
            }
            .auth-form h3 {
                font-size: 1.8em;
            }
            .admin-form-section h2, .song-list-section h2 {
                font-size: 1.4em;
            }
            .form-group label {
                font-size: 1em;
            }
            .form-group input, .form-group textarea, .form-group select {
                padding: 10px 12px;
                font-size: 0.95em;
            }
            .song-table .song-poster {
                width: 50px;
                height: 50px;
            }
            #loadingOverlay img {
                max-width: 150px;
            }
            #loadingOverlay h2 {
                font-size: 1.5em;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body>
    <div id="loadingOverlay">
        <img src="logo.png" alt="Sangeet Saathi Logo">
        <h2>BE A MUSIC PUBLISHER</h2>
    </div>

    <div class="container">
        <header>
            <div class="header-controls">
                <h1>Music Hub - Admin Panel</h1>
                <button id="logoutBtn" class="logout-btn hidden" onclick="handleLogout()">Logout</button>
            </div>
        </header>

        <main>
            <section id="authSection" class="auth-section hidden">
                <div id="loginForm" class="auth-form">
                    <h3>Admin Login</h3>
                    <div class="form-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="handleLogin()">Login</button>
                    </div>
                    <p class="auth-toggle-link">Don't have an account? <a href="#" onclick="showRegisterForm()">Register here</a></p>
                </div>

                <div id="registerForm" class="auth-form hidden">
                    <h3>Admin Register</h3>
                    <div class="form-group">
                        <label for="registerEmail">Email:</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password:</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="handleRegister()">Register</button>
                    </div>
                    <p class="auth-toggle-link">Already have an account? <a href="#" onclick="showLoginForm()">Login here</a></p>
                </div>
                <p id="authMessage" class="auth-message"></p>
            </section>

            <section id="adminDashboard" class="hidden">
                <section class="admin-form-section">
                    <h2 id="formTitle">Add New Song</h2>
                    <form id="songForm">
                        <input type="hidden" id="songId">
                        <div class="form-group">
                            <label for="title">Song Title:</label>
                            <input type="text" id="title" required>
                        </div>
                        <div class="form-group">
                            <label for="artist">Artist:</label>
                            <input type="text" id="artist" required>
                        </div>
                        <div class="form-group">
                            <label for="language">Language:</label>
                            <select id="language" required>
                                <option value="">Select Language</option>
                                <option value="Hindi">Hindi</option>
                                <option value="English">English</option>
                                <option value="Punjabi">Punjabi</option>
                                <option value="Bhojpuri">Bhojpuri</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="posterFile">Upload Poster Image:</label>
                            <input type="file" id="posterFile" accept="image/*">
                            <small>(Optional: Upload an image file for the song poster)</small>
                            <input type="hidden" id="posterUrl">
                            <div id="posterPreview" style="margin-top: 10px; display: none;">
                                <img id="previewImage" src="" alt="Poster Preview">
                                <p>Image will appear here after selection.</p>
                            </div>
                            <p id="posterUploadStatus" class="upload-status"></p>
                        </div>
                        <div class="form-group">
                            <label for="audioFile">Upload Song Audio File:</label>
                            <input type="file" id="audioFile" accept="audio/*">
                            <small>(Required for new songs. Accepted formats: MP3, WAV, OGG, etc.)</small>
                            <input type="hidden" id="audioUrl">
                            <p id="audioUploadStatus" class="upload-status"></p>
                        </div>
                        <div class="form-group">
                            <label for="isPublished">Publish Song:</label>
                            <input type="checkbox" id="isPublished">
                            <small>(Check to make the song visible in the main app)</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" id="submitBtn">Add Song</button>
                            <button type="button" id="cancelEditBtn" class="cancel-btn" style="display: none;">Cancel Edit</button>
                        </div>
                    </form>
                </section>

                <section class="song-list-section">
                    <h2>My Songs</h2>
                    <div id="mySongsList">
                        <p style="text-align: center; color: var(--text-color);">Loading your published songs...</p>
                    </div>
                </section>

                <section class="song-list-section">
                    <h2>All Songs</h2>
                    <div id="allSongsList">
                        <p style="text-align: center; color: var(--text-color);">Loading all songs...</p>
                    </div>
                </section>
            </section>
        </main>
    </div>

    <script>
        // --- API Keys and Cloud Names ---
        const IMGBB_API_KEY = '7184e56bb0953c0545409c441c402a66';
        const CLOUDINARY_CLOUD_NAME = 'dt9i6qr4z'; // Your Cloudinary Cloud Name
        const CLOUDINARY_UPLOAD_PRESET = 'Songs_upload'; // Your Cloudinary Unsigned Upload Preset for songs

        // 1. Firebase Configuration (Same as your public app)
        const firebaseConfig = {
            apiKey: "AIzaSyBzdm1Qjgxqb6v8tYUJ4d5KTTgfYLjDbe0",
            authDomain: "rkchat-2319f.firebaseapp.com",
            projectId: "rkchat-2319f",
            storageBucket: "rkchat-2319f.firebasestorage.app",
            messagingSenderId: "1023660188375",
            appId: "1:1023660188375:web:5e1884a6d1b5aaadbb8692"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // Initialize Firebase Auth

        // 2. DOM Elements for Auth
        const authSection = document.getElementById('authSection');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const authMessageDiv = document.getElementById('authMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const loadingOverlay = document.getElementById('loadingOverlay'); // New: Loading overlay element


        // 3. DOM Elements for Song Management
        const songForm = document.getElementById('songForm');
        const songIdField = document.getElementById('songId');
        const titleInput = document.getElementById('title');
        const artistInput = document.getElementById('artist');
        const languageSelect = document.getElementById('language');
        const posterFileInput = document.getElementById('posterFile');
        const posterUrlInput = document.getElementById('posterUrl'); // Hidden field to store ImgBB URL
        const posterPreviewDiv = document.getElementById('posterPreview');
        const previewImage = document.getElementById('previewImage');
        const posterUploadStatus = document.getElementById('posterUploadStatus'); // New status message for poster

        const audioFileInput = document.getElementById('audioFile'); // New: Audio file input
        const audioUrlInput = document.getElementById('audioUrl'); // Hidden field to store Cloudinary URL
        const audioUploadStatus = document.getElementById('audioUploadStatus'); // New status message for audio

        const isPublishedCheckbox = document.getElementById('isPublished');
        const submitBtn = document.getElementById('submitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const formTitle = document.getElementById('formTitle');

        const mySongsListDiv = document.getElementById('mySongsList');
        const allSongsListDiv = document.getElementById('allSongsList');

        let editingSongId = null;
        let currentUserId = null;


        // --- AUTHENTICATION FUNCTIONS ---

        function showRegisterForm() {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            authMessageDiv.textContent = '';
            authMessageDiv.className = 'auth-message';
        }

        function showLoginForm() {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            authMessageDiv.textContent = '';
            authMessageDiv.className = 'auth-message';
        }

        function showAdminDashboard() {
            authSection.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            fetchMySongs();
            fetchAllSongs();
            loadingOverlay.classList.add('hidden'); // Hide loading screen
        }

        function showAuthSection() {
            adminDashboard.classList.add('hidden');
            authSection.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            loginEmailInput.value = '';
            loginPasswordInput.value = '';
            registerEmailInput.value = '';
            registerPasswordInput.value = '';
            authMessageDiv.textContent = '';
            authMessageDiv.className = 'auth-message';
            mySongsListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">Loading your published songs...</p>';
            allSongsListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">Loading all songs...</p>';
            loadingOverlay.classList.add('hidden'); // Hide loading screen
        }

        async function handleRegister() {
            const email = registerEmailInput.value.trim();
            const password = registerPasswordInput.value.trim();

            if (!email || !password) {
                authMessageDiv.textContent = 'Please enter both email and password.';
                authMessageDiv.className = 'auth-message error';
                return;
            }

            if (password.length < 6) {
                authMessageDiv.textContent = 'Password should be at least 6 characters long.';
                authMessageDiv.className = 'auth-message error';
                return;
            }

            authMessageDiv.textContent = 'Registering...';
            authMessageDiv.className = 'auth-message';

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                authMessageDiv.textContent = 'Registration successful! You can now log in.';
                authMessageDiv.className = 'auth-message success';
                showLoginForm();
            } catch (error) {
                console.error("Registration error:", error.message);
                authMessageDiv.textContent = `Registration failed: ${error.message}`;
                authMessageDiv.className = 'auth-message error';
            }
        }

        async function handleLogin() {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!email || !password) {
                authMessageDiv.textContent = 'Please enter both email and password.';
                authMessageDiv.className = 'auth-message error';
                return;
            }

            authMessageDiv.textContent = 'Logging in...';
            authMessageDiv.className = 'auth-message';

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error("Login error:", error.message);
                authMessageDiv.textContent = `Login failed: ${error.message}`;
                authMessageDiv.className = 'auth-message error';
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Logout error:", error.message);
                alert(`Logout failed: ${error.message}`);
            }
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserId = user.uid;
                console.log('User logged in:', user.email, 'UID:', currentUserId);
                showAdminDashboard();
            } else {
                currentUserId = null;
                console.log('User logged out.');
                showAuthSection();
            }
        });


        // --- UPLOAD FUNCTIONS ---

        function getGoogleDriveDirectLink(fileId) {
            return `https://docs.google.com/uc?export=download&id=${fileId}`;
        }

        // ImgBB Image Upload Function
        async function uploadImageToImgBB(imageFile) {
            if (!imageFile) {
                posterUploadStatus.textContent = '';
                return null;
            }

            posterUploadStatus.textContent = 'Uploading poster...';
            posterUploadStatus.className = 'upload-status';

            const formData = new FormData();
            formData.append('image', imageFile); // ImgBB expects the file to be named 'image'

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    posterUploadStatus.textContent = 'Poster uploaded successfully!';
                    posterUploadStatus.className = 'upload-status success';
                    return data.data.url;
                } else {
                    console.error("ImgBB upload failed:", data.error.message);
                    posterUploadStatus.textContent = `Poster upload failed: ${data.error.message}`;
                    posterUploadStatus.className = 'upload-status error';
                    return null;
                }
            } catch (error) {
                console.error("Error uploading image to ImgBB:", error);
                posterUploadStatus.textContent = "An error occurred during poster upload.";
                posterUploadStatus.className = 'upload-status error';
                return null;
            }
        }

        // Cloudinary Audio Upload Function
        async function uploadAudioToCloudinary(audioFile) {
            if (!audioFile) {
                audioUploadStatus.textContent = '';
                return null;
            }

            audioUploadStatus.textContent = 'Uploading audio...';
            audioUploadStatus.className = 'upload-status';

            const formData = new FormData();
            formData.append('file', audioFile);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                // Cloudinary treats audio as 'video' resource type for direct uploads
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`,
                    {
                        method: 'POST',
                        body: formData,
                    }
                );
                const data = await response.json();
                if (data.secure_url) {
                    audioUploadStatus.textContent = 'Audio uploaded successfully!';
                    audioUploadStatus.className = 'upload-status success';
                    return data.secure_url; // This is the public URL of the uploaded audio file
                } else {
                    console.error("Cloudinary audio upload failed:", data.error.message);
                    audioUploadStatus.textContent = `Audio upload failed: ${data.error.message}`;
                    audioUploadStatus.className = 'upload-status error';
                    return null;
                }
            } catch (error) {
                console.error("Error uploading audio to Cloudinary:", error);
                audioUploadStatus.textContent = "An error occurred during audio upload.";
                audioUploadStatus.className = 'upload-status error';
                return null;
            }
        }

        // Event listener for poster file input to show preview
        posterFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    posterPreviewDiv.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                posterPreviewDiv.style.display = 'none';
                previewImage.src = '';
            }
            posterUploadStatus.textContent = ''; // Clear status on file change
        });

        // Event listener for audio file input to clear status
        audioFileInput.addEventListener('change', () => {
            audioUploadStatus.textContent = ''; // Clear status on file change
        });


        // --- SONG MANAGEMENT FUNCTIONS ---

        // Add/Update Song Functionality
        songForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            submitBtn.disabled = true;
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = 'Processing...'; // Change button text to indicate work

            let finalPosterUrl = posterUrlInput.value; // Start with existing URL if editing
            let finalAudioUrl = audioUrlInput.value; // Start with existing URL if editing

            // --- Handle Poster Upload ---
            if (posterFileInput.files.length > 0) {
                finalPosterUrl = await uploadImageToImgBB(posterFileInput.files[0]);
                if (!finalPosterUrl) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    return; // Stop if poster upload failed
                }
            }

            // --- Handle Audio Upload ---
            if (audioFileInput.files.length > 0) {
                finalAudioUrl = await uploadAudioToCloudinary(audioFileInput.files[0]);
                if (!finalAudioUrl) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    return; // Stop if audio upload failed
                }
            } else if (!editingSongId) { // Audio file is required for new songs
                alert('Please upload an audio file for the song.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }


            const songData = {
                title: titleInput.value.trim(),
                artist: artistInput.value.trim(),
                language: languageSelect.value,
                posterUrl: finalPosterUrl, // Use the uploaded URL
                audioUrl: finalAudioUrl, // Use the uploaded URL
                isPublished: isPublishedCheckbox.checked,
                // If editing, try to preserve existing playCount, otherwise set to 0
                playCount: typeof editingSongId === 'string' ? (await db.collection('songs').doc(editingSongId).get()).data().playCount || 0 : 0,
                // Add/Update timestamp for sorting
                uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                publisherId: currentUserId,
                publisherEmail: auth.currentUser.email
            };

            try {
                if (editingSongId) {
                    // This check for editing rights is already correctly implemented
                    const songDoc = await db.collection('songs').doc(editingSongId).get();
                    if (!songDoc.exists) {
                         alert('Song not found for editing.');
                         submitBtn.disabled = false;
                         submitBtn.textContent = originalBtnText;
                         return;
                    }
                    if (songDoc.data().publisherId !== currentUserId) {
                        alert('You can only edit songs you have uploaded.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalBtnText;
                        return;
                    }

                    await db.collection('songs').doc(editingSongId).update(songData);
                    alert('Song updated successfully!');
                } else {
                    await db.collection('songs').add(songData);
                    alert('Song added successfully!');
                }
                songForm.reset();
                resetFormForAdd();
                fetchMySongs();
                fetchAllSongs();
            } catch (error) {
                console.error("Error adding/updating song:", error);
                alert(`Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                posterUploadStatus.textContent = '';
                audioUploadStatus.textContent = '';
            }
        });

        // Edit Song (restricted to own songs)
        async function editSong(id) {
            try {
                const doc = await db.collection('songs').doc(id).get();
                if (doc.exists) {
                    const song = doc.data();

                    // ENSURE ONLY OWNER CAN EDIT
                    if (song.publisherId !== currentUserId) {
                        alert('You can only edit songs you have uploaded.');
                        return;
                    }

                    editingSongId = id;
                    formTitle.textContent = 'Edit Song';
                    submitBtn.textContent = 'Update Song';
                    cancelEditBtn.style.display = 'inline-block';

                    titleInput.value = song.title;
                    artistInput.value = song.artist;
                    languageSelect.value = song.language || '';

                    posterUrlInput.value = song.posterUrl || '';
                    if (song.posterUrl) {
                        previewImage.src = song.posterUrl;
                        posterPreviewDiv.style.display = 'block';
                    } else {
                        posterPreviewDiv.style.display = 'none';
                        previewImage.src = '';
                    }
                    posterFileInput.value = '';

                    audioUrlInput.value = song.audioUrl || '';
                    audioFileInput.value = '';

                    isPublishedCheckbox.checked = song.isPublished || false;

                    posterUploadStatus.textContent = '';
                    audioUploadStatus.textContent = '';

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    alert('Song not found!');
                }
            } catch (error) {
                console.error("Error fetching song for edit:", error);
                alert('Error loading song for edit.');
            }
        }

        // Delete Song (NOW restricted to own songs)
        async function deleteSong(id) {
            if (confirm('Are you sure you want to delete this song? This action cannot be undone.')) {
                try {
                    const songDoc = await db.collection('songs').doc(id).get();
                    if (!songDoc.exists) {
                        alert('Song not found for deletion.');
                        return;
                    }
                    // ENSURE ONLY OWNER CAN DELETE
                    if (songDoc.data().publisherId !== currentUserId) {
                        alert('You can only delete songs you have uploaded.');
                        return;
                    }

                    await db.collection('songs').doc(id).delete();
                    alert('Song deleted successfully!');
                    fetchMySongs(); // Refresh "My Songs"
                    fetchAllSongs(); // Refresh "All Songs"
                } catch (error) {
                    console.error("Error deleting song:", error);
                    alert('Error deleting song. Please check the console for details.');
                }
            }
        }

        // Toggle Publish Status (restricted to own songs)
        async function togglePublishStatus(id, currentStatus) {
            try {
                const songDoc = await db.collection('songs').doc(id).get();
                if (!songDoc.exists || songDoc.data().publisherId !== currentUserId) {
                    alert('You do not have permission to change the publish status of this song.');
                    return;
                }

                await db.collection('songs').doc(id).update({ isPublished: !currentStatus });
                alert(`Song ${!currentStatus ? 'published' : 'unpublished'} successfully!`);
                fetchMySongs();
                fetchAllSongs();
            } catch (error) {
                console.error("Error toggling publish status:", error);
                alert('Error updating publish status.');
            }
        }

        function resetFormForAdd() {
            editingSongId = null;
            formTitle.textContent = 'Add New Song';
            submitBtn.textContent = 'Add Song';
            cancelEditBtn.style.display = 'none';
            songForm.reset();
            isPublishedCheckbox.checked = false;
            posterPreviewDiv.style.display = 'none';
            previewImage.src = '';
            posterFileInput.value = '';
            audioFileInput.value = '';
            posterUrlInput.value = '';
            audioUrlInput.value = '';
            posterUploadStatus.textContent = '';
            audioUploadStatus.textContent = '';
        }

        cancelEditBtn.addEventListener('click', resetFormForAdd);

        // Render functions for song lists
        function renderMySongs(songs) {
            if (songs.length === 0) {
                mySongsListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">You haven\'t added any songs yet.</p>';
                return;
            }

            let tableHtml = `
                <table class="song-table my-songs-table">
                    <thead>
                        <tr>
                            <th>Poster</th>
                            <th>Title</th>
                            <th>Artist</th>
                            <th>Language</th>
                            <th>Plays</th>
                            <th>Published</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            songs.forEach(song => {
                const posterSrc = song.posterUrl || 'https://via.placeholder.com/60/6a0dad/ffffff?text=No+Art';
                const playCountDisplay = typeof song.playCount === 'number' ? song.playCount.toLocaleString() : '0';
                const publishedStatus = song.isPublished ? '<span class="status-published">Yes</span>' : '<span class="status-unpublished">No</span>';

                tableHtml += `
                    <tr>
                        <td><img src="${posterSrc}" alt="Poster" class="song-poster"></td>
                        <td>${song.title}</td>
                        <td>${song.artist}</td>
                        <td>${song.language || 'N/A'}</td>
                        <td>${playCountDisplay}</td>
                        <td>${publishedStatus}</td>
                        <td class="actions">
                            <button class="edit-btn" data-id="${song.id}">Edit</button>
                            <button class="delete-btn" data-id="${song.id}">Delete</button>
                            <button class="toggle-publish-btn" data-id="${song.id}" data-published="${song.isPublished}">
                                ${song.isPublished ? 'Unpublish' : 'Publish'}
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;
            mySongsListDiv.innerHTML = tableHtml;

            document.querySelectorAll('#mySongsList .edit-btn').forEach(button => {
                button.addEventListener('click', (e) => editSong(e.target.dataset.id));
            });
            document.querySelectorAll('#mySongsList .delete-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteSong(e.target.dataset.id));
            });
            document.querySelectorAll('#mySongsList .toggle-publish-btn').forEach(button => {
                button.addEventListener('click', (e) => togglePublishStatus(e.target.dataset.id, e.target.dataset.published === 'true'));
            });
        }

        // Modified renderAllSongs to conditionally show delete buttons
        function renderAllSongs(songs) {
            if (songs.length === 0) {
                allSongsListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">No songs found in the system.</p>';
                return;
            }

            let tableHtml = `
                <table class="song-table all-songs-table">
                    <thead>
                        <tr>
                            <th>Poster</th>
                            <th>Title</th>
                            <th>Artist</th>
                            <th>Language</th>
                            <th>Plays</th>
                            <th>Published</th>
                            <th>Publisher</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            songs.forEach(song => {
                const posterSrc = song.posterUrl || 'https://via.placeholder.com/60/6a0dad/ffffff?text=No+Art';
                const playCountDisplay = typeof song.playCount === 'number' ? song.playCount.toLocaleString() : '0';
                const publishedStatus = song.isPublished ? '<span class="status-published">Yes</span>' : '<span class="status-unpublished">No</span>';
                const publisherInfo = song.publisherEmail ? song.publisherEmail : (song.publisherId ? `ID: ${song.publisherId.substring(0, 6)}...` : 'N/A');

                // Conditionally render action buttons based on publisherId
                let actionsHtml = '';
                if (currentUserId && song.publisherId === currentUserId) {
                    actionsHtml = `<button class="delete-btn" data-id="${song.id}">Delete</button>`;
                } else {
                    actionsHtml = 'N/A'; // Or leave empty
                }

                tableHtml += `
                    <tr>
                        <td><img src="${posterSrc}" alt="Poster" class="song-poster"></td>
                        <td>${song.title}</td>
                        <td>${song.artist}</td>
                        <td>${song.language || 'N/A'}</td>
                        <td>${playCountDisplay}</td>
                        <td>${publishedStatus}</td>
                        <td><span class="publisher-info">${publisherInfo}</span></td>
                        <td class="actions">
                            ${actionsHtml}
                        </td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;
            allSongsListDiv.innerHTML = tableHtml;

            // Add event listeners ONLY to the visible delete buttons in the "All Songs" table
            document.querySelectorAll('#allSongsList .delete-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteSong(e.target.dataset.id));
            });
        }

        async function fetchMySongs() {
            if (!currentUserId) {
                mySongsListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">Not logged in. Cannot fetch your songs.</p>';
                return;
            }
            mySongsListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">Loading your published songs...</p>';
            try {
                const snapshot = await db.collection('songs').where('publisherId', '==', currentUserId).orderBy('uploadedAt', 'desc').get();
                const songs = [];
                snapshot.forEach(doc => {
                    songs.push({ id: doc.id, ...doc.data() });
                });
                renderMySongs(songs);
            } catch (error) {
                console.error("Error fetching my songs:", error);
                mySongsListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">Error loading your songs. Check console for details.</p>';
            }
        }

        async function fetchAllSongs() {
            allSongsListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">Loading all songs...</p>';
            try {
                const snapshot = await db.collection('songs').orderBy('uploadedAt', 'desc').get();
                const songs = [];
                snapshot.forEach(doc => {
                    songs.push({ id: doc.id, ...doc.data() });
                });
                renderAllSongs(songs);
            } catch (error) {
                console.error("Error fetching all songs:", error);
                allSongsListDiv.innerHTML = '<p style="text-align: center; color: var(--text-color);">Error loading all songs. Check console for details.</p>';
            }
        }
    </script>
</body>
</html>